Программа мониторинга продуктов Микроарт:

Микроконтроллера
Инвертора МАП

Используется протокол от ООО Микроарт

Версия 1.01b

Программа основана на технологии клиент-сервер. Распространяется на условиях "как есть" в виде открытого кода.

Серверная часть. Основана на линукс-системе. Разрабатывалась и тестировалась на CentOS 5.11 final i386
Сейчас работа ведется под Raspbian (клон Debian)

mapd.c - демон, который читает с указанного порта состояние работы МАП и записывает в БД mysql
mpptd.с - демон, который читает с указанного порта состояние работы MPPT и записывает в БД mysql

компилируется с указанием линковщику расположения библиотек mysql:
gcc mapd.c -o mapd `mysql_config --cflags --libs`

На пк (мини, микро-пк) должна быть установлена система linux, средства разработки для компиляции программы (gcc и т.п.), а также установлена и настроена MySql. Созданы 2 таблицы в БД "map" - data и mppt
Структуры таблиц присутствуют в архиве
пользователь на чтение по умолчанию (прописан в коде) - monitor. Pass: energy
Начиная с поздних версий пользователь должен обладать всеми основными правами уровня базы, кроме GRANT

В текстах программ не всегда выбирался наиболее короткий и эффективный код. Там, где возможно редактирование и понимание процессов, переменных и пр, использван более понятный код и структуры. Вместо массивов использованы именованные переменные в структурах, имена которых совпадают с именами полей в таблицах БД.

Также, на сервер устанавливается любой веб-сервер (тестировалось под nginx + php + php-fpm) и php
Для веб-интерфейса использованы стандартные библиотеки: JSGadget и JPGraph. Они, а так же jquery уже находятся в архиве и не требуют установки и загрузки. Содержимое каталога www должно быть размещено от корня рабочего каталога веб-сайта. Например, /var/www/html

Безопасности веб-сайта пока не уделено никакого внимания. Эта задача будет решаться после доработки полной системы.

Известные ошибки и ограничениия:

1. совместный график по мощностям (история) - убран. В целях устранения возожных проблем с производительностью на маломощных платформах
2. Демоны автоматически завершают работу при отсутствии устройства, с которым они работали. Например, выдернут переходник USB-RS232
Для авторестарта демонов можно скопировать их в /usr/bin и из основного терминала запустить скрипт (в архиве пример - mar (map auto restart).
Параметры запуска: ./mar 1 > /dev/null 2 > /dev/null &
После этого, при завершении демона, он будет пытаться стартовать снова.

Завершение демона: kill -SIGTERM pid(номер процесса)


Рекомендации по применению JPGraph:

Для создания изображения графика при большой выборке компьютер как правило работает на максимальной мощности. Для микрокомпьютеров целесообразно уменьшить количество строк выборки и увеличить время выполнения скриптов php (переменная execution_time в php.ini). Для nginx требуются дополнительные настройки www.conf (request_terminate_timeout) в php/fpm/pool.d и default в sites-available переменная fastcgi_read_timeout
Обязательно устанавливайте PHP акселератор на своей платформе.


Веб-интерфейс написан макимально "легко", для работы на любом устройстве. Вся анимация и графика основана на возможностях JS и CSS. 
Пользователь имеет возможность гибкой кастомизации любого элемента интерфейса - цвета, положения, поведения, диапазоны и вид шкал. Фактически интерфейс представляет собой настроенный для работы с БД открытый инструментарий.

Сриншоты веб-интерфейса прилагаются.



1.02b Исправлено:

1.Ячейка P_OUT MPPT - выходная мощность
2.Применены более точные расчеты токов и мощностей.
3.Изменено 2 поля БД data. 
 	25 	_INET_16_4 	decimal(10,1) 	
	26 	_IAcc_med_A_u16 	decimal(10,1) 
4.Поправлена запись в БД значений
6. Другие мелкие исправления.
7. Убрана одна функция в JPGraph для совместимости с другими версиями PHP, в частности на Raspbian Pi
8. Внесены соответствующие изменения в веб-интерфейс

1.03b

1. Удалена строка БД mppt. 'Pwr_W'. Теперь энергия хранится сразу в кВтч 'Pwr_kW' с точностью до тысячных. Сделано для удобства SQL-запросов для выборки статистики
2. Расчетные мощности округлены до целых в веб-скриптах 
3. Поправлена P_Out. Было неверно расчитано смещение.
4. Немного перемещены элементы на панели приборов gauges.php с целью размещения мониторинга BMS в дальнейшем
5. добавлен расчет кпд для MPPT
6. добавлена расчетная мощность по АКБ, Вт
7. Все единицы измерения теперь именованы по русски.
9. Сделана столбчатая диаграмма по статистике выработки/потребления солнечной энергии (MPPT)

1.04b

1. Проведены работы по оптимизации БД. Поля определены по размеру в соответствие с хранимыми данными.
Основные таблицы - mppt и data сегментируются на 37 разделов. По 10 календарных дней года на каждый. 36х10 и 1х5. Для этого устанавливаются 2 первичных ключа - number и date. В итоге mysql при выборке по датам работает с небольшими разделами и запросы происходят за гораздо меньшее время. Для флеш-накопителей это несет тоже пользу. 

Существующую таблицу можно дефрагментировать такими командами ( с измененим первичных ключей). Пример для таблицы mppt.

alter table mppt DROP PRIMARY KEY, add PRIMARY KEY (`number`, `date`);

ALTER table mppt PARTITION BY RANGE (DAYOFYEAR (date) (PARTITION p01 VALUES LESS THAN (10), PARTITION p02 VALUES LESS THAN (20), PARTITION p03 VALUES LESS THAN (30), PARTITION p04 VALUES LESS THAN (40), PARTITION p05 VALUES LESS THAN (50), PARTITION p06 VALUES LESS THAN (60), PARTITION p07 VALUES LESS THAN (70), PARTITION p08 VALUES LESS THAN (80), PARTITION p09 VALUES LESS THAN (90), PARTITION p11 VALUES LESS THAN (110), PARTITION p12 VALUES LESS THAN (120), PARTITION p13 VALUES LESS THAN (130), PARTITION p14 VALUES LESS THAN (140), PARTITION p15 VALUES LESS THAN (150), PARTITION p16 VALUES LESS THAN (160), PARTITION p17 VALUES LESS THAN (170), PARTITION p18 VALUES LESS THAN (180), PARTITION p19 VALUES LESS THAN (190), PARTITION p20 VALUES LESS THAN (200), PARTITION p21 VALUES LESS THAN (210), PARTITION p22 VALUES LESS THAN (220), PARTITION p23 VALUES LESS THAN (230), PARTITION p24 VALUES LESS THAN (240), PARTITION p25 VALUES LESS THAN (250), PARTITION p26 VALUES LESS THAN (260), PARTITION p27 VALUES LESS THAN (270), PARTITION p28 VALUES LESS THAN (280), PARTITION p29 VALUES LESS THAN (290), PARTITION p30 VALUES LESS THAN (300), PARTITION p31 VALUES LESS THAN (310), PARTITION p32 VALUES LESS THAN (320), PARTITION p33 VALUES LESS THAN (330), PARTITION p34 VALUES LESS THAN (340), PARTITION p35 VALUES LESS THAN (350), PARTITION p36 VALUES LESS THAN (360), PARTITION p37 VALUES LESS THAN (370);

Для флеш-накопителей рекомендуется в настройке mysql поставить параметр innodb_flush_log_at_trx_commit в значение 2.
Это будет означать, что лог будет записываться на диск не каждую секунду, а по усмотрению ОС. 

Создание БД и таблиц теперь в пакете идет в виде sql скрипта для Mysql.
Пользователь в программах по умолчанию - monitor
Пароль - energy

2. Добавлена таблица настроек МАП (settings). Туда при старте демона считываются и записываются абсолютно все ячейки EEPROM
3. Привилегии пользователя monitor должны быть расширены. На уровне БД он должен обладать правами создавать/очищать таблицы, добавлять/изменять, удалять данные
4. Добавлена таблица bms_alert. Для тех, у кого есть bms. В эту таблицу записываются все нештатные ситуации, когда температура или напряжение на ячейке вне диапазона. Записываются значения по всем имеющимся ячейкам. Пороги установлены в секции #define mapd
5. При наличии bms демон mapd автоматически создает в памяти оперативную таблицу bms, куда записываются значения мониторинга балансиров. Данные для длительного хранения не нужны и располагаются в памяти, для того, чтобы избежать многочисленных циклов записи на флеш-накопителях
6. Добавлена страница веб-интерфейса "ИНФО". На ней в виде простейшей таблицы выводятся все настройки МАП и информация о прошивке/платах
Таблица удобна для копирования в MS Word, e-mail клиенты и пр. для обращения в техподдержку Микроарт
7. Из демона mapd вырезана часть запуска внешних программ и скриптов пользователя. Сделано это во избежание падении демона и системы при наличии ошибок в программах пользователя. Данная возможность будет перенесена на уровень шелл-скриптов с помощью отдельной программы чтения полей из БД и реализована в ближайшее время (надеюсь)
8. Добавлена страница мониторинга BMS. Сделано для систем до 48В. Неподключенные балансиры выделяются серым цветом и содержат надпись: не подключен
Каждый раз отмечается цветом (голубым) напряжение самой низкой и красным - самой высокой ячейки.
Если температура или напряжение на БМС вне допуска - загорается красный LED.
При нормальном опросе мигают зеленые.
Для каждой ячейки отображается температура (если подключен датчик), напряжение и ток.
% открытия транзистора от 0 до 100% отображается над шкалой зеленой полосой.

9. Реализованы синхронизированные графики текущих параметров на основе библиотек ZingChart. На графиках работают перекрестья при наведении мыши, для снятия синхронных значений. На экране умещается 60 секунд. В легенде указано среднее значение для параметра за 4 минуты (240 значений). После этого график сбрасывается и начинается сбор новой серии данных.
По метрологическим соображениям график баланса АКБ реализован с возможностью выбора источника данных.
Либо это МАП, у которого содержатся средние значения исходящих токов по всем MPPT и значение собственного тока на секции АКБ-МАП. Это возможно при наличии соединения по цифровой шине I2C.
Либо это MPPT, при отсутствии I2C. Тогда берутся значения с двух внешних датчиков тока ДТ1 и ДТ2 и исходящий ток MPPT.
Баланс определяется как алгебраическая сумма токов на/с АКБ с учетом знака.
При щелчке мышкой на диаграмме возможен выбор опций сохранения, формата отображения и пр.
Графики ZingChart являются весьма надежным решением, работающим на любой платформе

10. Исправлено множество мелких погрешностей и ошибок, выявленных по результатам исследования логов nginx и т.п.


1.04.01b

1. Исправлено вычисление тока для графика токов ДТ1, ДТ2
2. На странице приборов возвращен к нормальному только положительному значению ток в ветке АКБ-МАП. 
3. данные из EEPROM (настройки МАП) автоматически обновляются при любом изменении EEPROM (через настройки или программу)
4. Добавлена синхронизация времени МАП и сервера в 00:00:00


1.05b

1. Исправлены некоторые ошибки
2. Добавлена страница /sys.php
Через нее доступна остановка демонов mapd и mpptd, а также перезагрузка
Для того, чтобы эта опция работала на других платформах, вам необходимо создать папку /var/map с правами доступа 777
Затем по примеру crontab.txt отредактировать crontab командой crontab -e
Скрипт map_cd, который необходимо разместить в /usr/bin будет проверять каждые 20 секунд наличие сигнальных файлов в папке /var/map и выполнять определенные действия
3. Шкала тока АКБ во вкладке Приборы разделена на отрицательные и положительные значения, как общепринято для АКБ. Минус - АКБ разряжается. Ток от АКБ. Плюс - ток к АКБ
4. Забыл написать для предыдущих версий - графики zingchart используют расширение JSON для получения массивов данных. Обычно оно входит в состав PHP, однако на некоторых платформах, а также для php 5.5 может устанавливаться отдельно. 
5. Наличие файлов .map и .mppt в каталоге /var/map учитывается веб-интерфейсом. Если отсутствует файл .mppt, веб интерфейс считает, что mppt контроллер не подключен и не будет отображать часть информации, касающейся контроллера

1.05.1b

1.Расширены диапазоны шкал под все модели контроллеров
2.Изменен фон меню (микроарт лого прислал)
3.Диапазон шкалы Uакб автоматически меняется под систему 12, 24 или 48В 

1.05.02b

1. Страница "приборы": в случае потери связи с МАП/МППТ из БД читаются одинаковые данные. В этом случае шкалы приборов окрашиваются в красный цвет
2. Страница "история": в поле время начала и окончания автоматически подставляется текущее время. Дата начала - вчерашний день. Дата окончания - сегодня. Кнопка "Submit" переделана на "Поехали!" :)
3. Страница "мультиграф": автоматическая шкала и цветовые диапазоны под 12, 24, 48 и 96В
4. Добавлен переход в меню со всех страничек. На графических в виде маленького маркера в виде красного квадрата с обратной стрелкой.
5. Страница "приборы": теперь максимальный ток АКБ на шкале зависит от мощности модели МАП/ напряжения АКБ
6. Поправлена неточность - при отсутствии сети из-за особенностей расчета приборы и график показывал 100В. Не проверено, но должно работать.


1.05.03b

1. В основном корректировки коснулись BMS. Немного поправлен демон чтения mapd. Убрана одна ненужная функция. 
2. Скорректированы запросы по bms к mysql
3. Если у вас уже была таблица bms, то перед запуском демона ее нужно удалить. mapd создаст новую с правильными полями.
(бала опечатка. Вместо decimal(2.2) надо decimal(3,2);
 



2.01b -----------------------------------------------------------------------------------------------------------------------------------
=============================================================== 2.01b====================================================================

Много сделано. Исправлены мелкие ошибки и неточности.


а) общие данные для релиза linux в целом

1. Настройка МАП. Сделано максимально универсально. Т.е. новые пункты меню МАП, если будут добавляться, можно будет легко добавить. Структуры меню и подменю описаны в файлах json
2. Для настройки МАП предусмотрено 2 режима - Restricted и Free. По-умолчанию restricted. Определяется наличием файла /var/map/.resctricted
В этом режиме вы не сможете изменить некоторые критические настройки и дать МАПу некоторые команды (типа остановить генерацию, сброс)
3. Данные для записи в ячейки памяти проходят тройной контроль по номеру ячейки и значению. На уровне клиента, сервера и на низком уровне - mapd

Я насколько мог все проверил, но если что, не обессудьте :D В любом случае не должно ничего писаться вне разрешенных значений и диапазонов. Это успокаивает, и не только вас. ;)

4. Данные в mapd для записи передаются через именованный fifo канал /var/map/to_map в виде 0xFF-адрес 2 байта - значение 1 байт
Итого, 4 байта. Этот подход позволяет очень просто из любой программы передавать команды МАПу.
5. Данные для записи разрешены только в адреса 0, 0x137-0x1B7,  что соответствует командам и адресам настройки через панель прибора
6. Обратное подтверждение идет через таблицу mysql eeprom_result
7. Не сделано - настройки реле DOMINATOR
8. Установка времени сделана так, как она хранится в МАП - с точностью до 10 минут. Текущее время также, чтобы не вводить дополнительный кусок кода для времени. Поскольку единицы минут хранятся в RAM и это нарушает всю целостность алгоритма. Кроме того, в обычных ситуациях, точности 10 минут достаточно. И время МАП в 00:00 ежедневно синхронизируется с локальным временем ПК. Поэтому следите за временем ПК и на МАП будет всегда актуальное текущее времия.
9. добавлен просмротр /var/log/syslog Для этого syslog должен иметь аттрибуты 644
10. В БД добавлено поле _I2C_err, определяющее код ошибки по шине I2C
11. Поправлены пороги тревоги для BMS, теперь они автоматически настраиваются для систем 3.7 и 3.9В
12. Переделан внешний вид меню. Добавлено системное меню. Все системные настройки теперь в разделе /setup
13. Для СМС-управления и уведомлений используется СМС-сервер с открытым кодом - http://smstools3.kekekasvi.com/
14. Настройка порта модема через системное меню используется определение имени устройства системой udev. Выполняемый скрипт /usr/sbin/modem_setup.sh вносит изменения в /etc/smsd.conf и рестартует сервер. Для корректного выполнения этих скриптов, они должны быть либо выполняться через cron, либо через внесение этих скриптов в /etc/sudoers. Вообще, еще раз позволю себе напомнить - следите за правами и владельцами и все будет работать. Избегайте необдуманных аттрибутов 777 и 666 :)
15. Отправкой уведомлений занимается скрипт /usr/sbin/sms_compose.sh
16. Приемом СМС и обработкой команд занимается скрипт /usr/sbin/sms_handler.sh - указывается в настройках /etc/smsd.conf
Если по какой-то причине вам нужно запретить принимать ту или иную команду, просто добавляете комментарий # в строку присвоения элементу массива to_map[] соответствующей команды. 
17. Система СМС уведомлений построена максимально гибко. Можно легко добавить любое поле БД для мониторинга
18. Настройки и текст СМС уведомлений находится в таблице БД sms_alert. Номера нахятся в dat файлах /var/map/allowed_numbers.dat и report_number.dat
19. Если оба поля проверяемого параметра равны, то проверка производится только на равенство этому параметру. Уведомление о выходе параметра за пределы диапазона приходит со значением параметра.
20. При возвращении параметра в заданный диапазон, также отправляется СМС: "alias" - ваш настраиваемый параметр в sms_handler.sh - is in range
21. USB модем должен быть переведен в режим "только модем", ПИН-код снят. Работа с ПИН-кодом возможна, он может быть вписан в /etc/smsd.conf
22. Доступны СМС команды: #report, #start, #stop, #charge_on, #charge_off
23. СМС сделаны на латинице, поскольку длина СМС на латинице 160 символов, против 70 на кириллице. 
24. Каждая командра (кроме #report) подтверждается ответным СМС
25. Проверка параметра для СМС-уведомления проводится каждые 30 сек. Можно изменить, поправив crontab
26. Меню "Пароль" делает следующее - пароль шифруется и выкладывается в папку /var/map/tmp_p в формате htpasswd 
Далее вам остается подстроить копирование этого файла через crontab туда, где это необходимо для вашей системы и настроек веб-сервера.
27. Образцы скриптов и crontab в релизе


===========================================Замечания и дополнения для Raspberry Pi=========================================================


----------------------------------------- УСТАНОВКА -----------------------------------------------------------------

Для Windows:

1. Устанавливаем DiskImager (входит в пакет. для других систем:  http://sourceforge.net/projects/win32diskimager/)
2. Готовим новую (можно немного б/у ;) micro-SD(HC) карту, желательно на 16ГБ и выше, класс 10 и выше. Образ записывается на карты от 16ГБ.
3. Запускаем DiskImager, выбираем источником файл image_map_2.0b_sd_16G.img
4. Приемник - наша SD карта
5. Нажимаем Write. Программа предупредит, что образ меньше, чем носитель и носитель может быть поврежден. Нас это не беспокоит. Жмем "Ок"
6. Когда запись закончена, безопасно извлекаем карту из системы. (в проводнике правой кнопкой на носителе - извлечь)
7. Устанавливаем карту в Raspberry Pi 2 (работает и в предыдущем поколении)
8. Загружаемся.

Для карт > 16ГБ:
----------------------------------------------------
Если вы не умеете подключаться через SSH консоль, тогда первую загрузку делайте с монитором и USB-клавиатурой
После загрузки в консоли:

Логин: pi 
Пароль: raspberry

Пользователь pi является членом группы sudoers

И ОБЯЗАТЕЛЬНО СРАЗУ первой командой выполняем: sudo raspi-config
Выбираем первый пункт меню - Expand filesystem. Это позволит расширить рабочий раздел до размера вашей флеш-карты.
После этого перезапускаемся.
----------------------------------------------------НАСТРОЙКА---------------------------------------------------------

По умолчанию IP адрес присваивается по dhcp
После того, как он присвоен, вы можете изменить любые настройки сети через интерфейс webmin (в образ включена последняя версия)
http://IP:10000
login:admin 
password: microart

Будьте аккуратны. При неверных настройках статического IP устройство может быть вовсе недоступно и если вы не умеете менять настройки через терминал вам придется вновь записывать образ на sd-карту.

Образ основан на debian релиз raspbian, откуда удалены все ненужные пакеты и настройки
Образ пока не проверен окончательно в работе!

По адресу: http://IP/update.html
доступна страница обновления. Через эту страничку позднее вы сможете устанавливать все новые обновления небольшого размера, которые я буду выпускать. Обновления подписываются ключом gpg и таким образом сохраняют целостность и аутентичность.

-------------------------------------------------------------------------------------------------------------

Образ идет с выключенными сервисами МАП и MPPT: mapd и mpptd
Чтобы запустить их, в системном меню - система - нажмите соответствующую кнопку
В логе #syslog всегда виден результат выполнения старта или остановки демона чтения/записи

При первом включении:
- включайте питание RasPi с подключенной LAN (если есть). Статический адрес RasPi лучше всего присвоить прямо через DHCP сервер
- первым в USB порт включаете адаптор для МАПа, чтобы он определился на USB0
- вторым подключаете адаптор для MPPT, если есть. Для того, чтобы он определился на USB1.
В дальнейшем положение адапторов не важно. Система запомнит id ваших адапторов и будет их привязывать к этим же USB
Только после этого запускайте сервисы МАП и MPPT


- USB модем. Питание RasPi должно быть не менее 1000-1500мА. Иначе может быть сбой и порча microSD карты
- образ лучше запускать на RasPi 2 с 1ГБ RAM. Потому что без файла подкачки (он отключен) может быть дефицит ОЗУ
- В системе применены ограничения и дополнения:
  - по умолчанию режим Restricted (см. выше о релизе linux)
  - в файле конфигурации веб-сервера nginx установлен доступ в папку настройки setup по паролю. В меню доступна смена имени пользователя и пароль. По умолчанию - admin, microart
  - в файле конфигурации веб-сервера /etc/nginx/sites-available/default под комментарием # находятся строки, раскомментировав которые, вы получите доступ в папку setup не только по паролю, но и только из локальной сети. Если адресное пространство у вас отлично от указанного 192.168.0.0/24, то измените это для своего случая
 
- добавлено обслуживание - принудительная проверка всей файловой системы при каждом рестарте
- для управления БД присутствует ссылка в основном каталоге веб-сервера - ~phpmyadmin
вход - http://ip/phpmyadmin
учетные данные: root, microart

Если вы планируете иметь открытый интерфейс в Интернет, файл /var/www/html/~phpmyadmin следует удалить. Это не удаляет саму систему администрирования БД, а лишь ссылку, которую потом можно легко восстановить.

----------------------------------------------------------------------------------------------------------------



====================================== 2.02b =====================================================================

1. Сделан мультиграф по истории. Теперь достаточно выбрать точку старта - дата и время и нажать "мультиграф". Начинается воспроизведение всех параметров с точки старта. 
2. В системное меню добавлен раздел "работа с БД". Работает пока как информация. Реакции на кнопки пока нет.
3. Поправлен php скрипт передачи данных в интерфейс настройки МАП.
4. Если вы будете пользоваться сервисом СМС, то имейте в виду, что скрипт sms_compose для сравнения чисел использует вызов perl
поскольку bash не поддерживает сравнения дробных чисел. Можно переделать, при остутствии perl в системе на php или bc, или на что у вас 
хватит фантазии :)

--------------------------------------- Raspberry Pi -----------------------------------------------------------------

1. Теперь образ на 16ГБ состоит из трех разделов. Загрузочный - fat, системный - ext4 без журналирования и раздел для баз данных (монтируется в /bases) ext2.
Если у вас флеш-накопитель большего объема, то после загрузки вы можете увеличить третий раздел средствами linux 
(остановить mysql (/etc/init.d/mysqsl), проверить раздел, увеличить раздел (удалить и созадть новый - fdisk), затем проверка раздела и увеличить файловую систему (resize2fs). 
2. изменены настройки mysql
3. добавлено автомонтирование usb носителей средствами udev
Это изменение, я надеюсь, улучшит надежность работы SD карт и улучшит возможность восстановления системы или БД после сбоя.
Поскольку при порче SD на сбоях питания затрагивались и системные файлы, и базы данных.
4. Применены все последние обновления и прошивки


================================2.03b =========================================
*****************************  Пре-релиз *************************************
==============================================================================

-------- Функции, реализованные для Raspbian на RasPi и включенные в релиз linux

1. Резеервное копирование базы данных на внешний носитель. Носители автоматически монтируются с уникальным постоянным именем
2. Восстановление базы данных с внешнего носителя (поиск в корневом каталоге файла *.sql)
3. Очистка таблиц текущей базы данных

примеры скриптов включены в релиз

----------------------------------- общие изменения -----------------
1. Изменен фон приборов при отсутствии новых данных от устройства в базе данных. Теперь они выглядят затененными
2. Частота на входе и выходе теперь указывается на панели "текст" и "приборы" с точностью до 0.1Гц
3. Интервал обновления данных на панели "приборы" увеличен с 1.0с до 1.3с
4. Добавлено исключение настроек подключенных BMS и MPPT, которое работало некорректно, по причине того, что
требовалось программировать ячейку RAM, а не EEPROM (оставлено в прошивках МАП для совместимости с предыдущими моделями). Изменение внесено в демон чтения mapd
5. Немного "почищен" код mapd.c и mpptd.c, изменены флаги открытия порта. Предварительно это влияет на корректность работы некоторых RS232-USB адапторов (полностью вопрос не исследован)

-------------------------------- RasPi -----------------------------

В первом (FAT) разделе USB Flash находится файл monitor.ini с описанием
Теперь режим restricted можно легко включить/выключить путем редактирования опции
Также настраивается режим получения IP адреса - dhcp или фиксированный статический 

boot.img обрезан в размер раздела - 56МБ


===========================2.05=====================================
релиз 

1. Изменен интерфейс "приборы"
2. Интерфейс сделан адапитивным. Можно подключать: МАП+МППТ, МАП, МППТ
3. Переписаны некоторые скрипты
4. Добавлены графики реального времени по мощности на панель "приборы"
5. Изменены настройки mysql для медленных USB-Flash (скорость записи менее 10Мбит/с)
6. Изменен сервис mpptd. Теперь, в отсутствии МАПа, он будет самостоятельно соединяться на первый последовательный порт (USB0)
7. В отсутствие МАП, кнопка настроек МАП заблокирована
8. Изменены графики Мультиграф. Теперь отображаются те графики, которые соответствуют подключенным приборам
9. При отсутствии МАП, данные о токах и напряжении АКБ берутся с МППТ
11. Изменены поля таблицы data по учету энергии. Теперь DECIMAL 10,1
12. На панель BMS добавлен расчет напряжения (смещения) средней точки блока АКБ в вольтах и %
13. Исправлены мелкие ошибки
13а. Демоны mapd.c и mpptd.c в этом релизе подготовлены для батарейного монитора и создают в ОЗУ
два разделяемых сегмента памяти по 1024байта
Строка компиляции для Дебиан:  gcc -o mapd -lrt mapd.c `mysql_config --cflags --libs`


не работает:

1. Пока в настройках МАП не сделана настройка реле МАП-доминатор


2.06a

1. В базу данных map - таблица mppt добавлено новое поле - windspeed SMALLINT(5) unsigned
2. В демон mpptd добавлена обработка ячейки по скорости вращения ветряка для версии MPPT для ветряков
3. Внесены еще дополнения в демоны mpptd и mapd
4. выпущен релиз 1.0а демона батарейного монитора batmon
5. Создана новая база данных battery для его работы. Структура и начальные данные в файле для импорта battery_full.sql
6. внесены соответстввующие изменения в интерфейс для отображения данных батарейного монитора и настройки
Описаны в прилагаемом rtf или txt файле battery_monitor

2.07b

1. В базу данных battery - таблица battery_info добавлены 2 поля dod_off и ah_off
2. Реализованы дополнительные настройки для батареи - отключение генерации МАП при определенном % глубины разряда или выбранным ампер-часам. Не путать с оставшимся зарядом батареи. Например, если вы видите 20%, то это значит, что DOD (глубина разряда) составила 80%
3. скрипт /usr/sbin/stop_gen.sh вызывается через crontab 1 раз в минуту и проверяет уровень разряда батареи при запущенных сервисах МАП и батарейного монитора. Если DOD либо потребленные ампер-часы превысили настройку, то посылается команда МАП - выкл.
МАП прекращает генерацию. Будьте внимательны - если у вас ПК запитан от 220В МАП, то этим выключится питание ПК
4. Если DOD или ампер-часы равны 0, то проверка не производится
5. Немного переработан интерфейс "приборы". Добавлены всплывающие подсказки для реле и режима работы MPPT
6. Таймер отдыха батареи после 600мин показывает время в часах
7. Забыл написать для прошлой версии - таблицы для АКБ - AGM, GEL, LiFePO4 3.9В не заполнены и не заданы в php. 
Если у вас такие АКБ - используйте ближайшую подходящую таблицу, затем отредактируйте рабочую и скопируйте в пользовательскую

2.08b

1. Добавлена информация о суммарном токе на АКБ всех подключенных контроллеров к МАП по шине I2C. В виде стрелочного прибора на панели «МАП» приборов
2. Расчет мощности в этом случае происходит по суммарному току.



2.09b

1. Исправлен запуск думона batmon. Теперь он стартует с задержкой 10с и проверяет наличие включенных МАП и MPPT 
2. Исправлено исчезновение надписи "> Гц >" в указателе частоты напряжения МАП при отключенном MPPT 
3. Дополнен скрипт /usr/sbin/gen_stop.sh и создан скрипт /usr/sbin/server_off.sh для отключения *nix серверов через SSH соединение. Инструкция для администраторов прилагается
4. Минорные исправления

2.10b

1. Для будущего - увеличено поле таблицы data - _I_mppt_avg до decimal(4,1)
2. Исправлена ошибка с чтением токов контроллеров с МАП при связи по I2C
3. Исправлен запуск сервиса батарейного монитора в системах с одним МАП/одним контроллером
4. Переписана страница управления сервисами. Теперь видно состояние работы основных сервисов. Добавлен сервис СМС
5. Для сервиса СМС создается технический файл /var/map/.sms
6. График "мощности" теперь для контроллеров берет суммарный ток всех контроллеров, подключенных к МАП по I2C, если таковые имеются

2.11b

1. Добавлены дополнительные поля в таблицу battery_state
2. Добавлен учет энергии в киловаттчасах от альтернативных источников с помощью батарейного монитора
Значение токов контроллеров получаются от МАП и оттуда же напряжение АКБ
3. Небольшие исправления ошибок 
4. Переписан crontab
5  Добавлена некоторая статистика по батарее
    - энергия на АКБ
    - энергия с АКБ
    - Счетчик суммарной энергии от контроллеров
	- дневной (сброс в 0 часов)
	- месячный (сброс в 0 часов 1 числа месяца)
	- пользовательский. Для сброс покамест идти по ссылке /makedrop.php
    - минимальное и максимальное напряжение на АКБ
    - количество автосинхронизаций
    - наиболее глубокий разряд
    - дата последнего заряда
6. теперь в режиме заряда АКБ показывается стадия заряда на панели "приборы"


3.01b 

Новая ступень эволюции :)
Добавлена функциональность "мастер-узел"
Теперь любой из компьютеров с ПО может быть сконфигурирован на мониторинг N узлов с версией ПО выше 3.01
Это необходимо в территориально-распределенных системах, а также в N-фазных сборках и сборках с множеством контроллеров.
Запросы на удаленный узлы посылает мастер-узел со своего IP и уже после этого отдает данные на консоль оператора
Однако, переход к мониторингу узла и настройке происходит без проксирования, непосредственно с ПК пользователя. Т.е.,
 если из внешней сети доступен только мастер-узел, вы можете мониторить все узлы через консоль мастер-узла. Однако, непосредственный
мониторинг и настройка узлов будут недоступны с ПК пользователя. Возможно, потом я добавлю веб-проксирование на мастер-узле

1. Создана БД master c таблицами nodes, в которой хранятся настройки узлов, и batmon - настройки узла, на котором запущен батарейный монитор
2. Для отображения узлов использована известная библиотека jsTree
3. На обращение мастер-узла к другим выделяется 2 секунды. По истечению соединение сбрасывается и недоступные панели начинают мерцать
4. Расчетная емкость С20 АКБ на мастер-панели без коррекции по температуре
5. Весь раздел размещен в /var/www/html/master
6. В этом разделе я уже позволил себе использовать растровые подложки и иконки, а также более "сжатый" код. Потому как кастомизировать
 тут сильно нечего, да и применение в большей степени промышленное.

Концепция батарейного монитора в структуре распределенных узлов:

    Каждый узел настраивается применительно к блоку АКБ, на который подключено все оборудование. Любой из узлов блока АКБ может использоваться
как батарейный монитор (в т.ч. и мастер-узел). Т.о. сохраняется единственная точка настройки АКБ, обработки событий по состоянию аккумулятора.

Следует, однако, учитывать, что батарейный монитор может собирать токи либо по I2C, и тогда корректная работа обеспечивается в схеме
МАП+N контроллеров.
Либо по RS232, тогда корректная работа будет обеспечена в схеме 1МАП+1контроллер
В схемах N МАП + N контроллеров корректная работа батарейного монитора будет обеспечена только на новых версиях МАП, где МАП сможет получать по I2C
токи с других МАП.
В ныне действующих системах N МАП [+N контроллеров] запускать батарейный монитор не рекомендуется. Он не сможет обеспечить корректные данные.

Все остальное, в общем, понятно, и ИМХО, описания не требует

Иные изменения:
1. Дополнен батарейный монитор на сброс полей
2. Исправлена ошибка подсчета кол-ва электричества от АКБ
3. В разделе "История" при запущенном батарейном мониторе, появляется некоторая статистика по АКБ
4. Где было возможно (в т.ч. идеологически), добавил вместо ссылок и квадратиков кнопку "меню"


---------------------------------------------------------------------------------------------

3.02 стабильная (надеюсь)
Исправлено:
1. Ошибка в ../master/node.js В некоторых режимах МАП скрипт переставал выполняться. В двух местах неверно стояла одинарная кавычка
2. Еще какие-то несущественные мелочи

--------------- RasPi --------------------------------------

Обновлена система и загрузчик. Все пакеты. mysql в т.ч.
Версия ядра 4.1.7-v7+
(нарезаем и boot.img и образ на носитель)

Добавлены специальные утилиты, которые помогут в восстановлении сбойного носителя и пустой БД.

1. Для версии f2fs установлен пакет f2fs-tools.
2. Для версии f2fs выполняется проверка раздела БД при каждой загрузке с принудительным исправлением ошибок
3. Добавлен скрипт /usr/sbin/pbase_restore.sh, который выполняет следующие действия:
- останавливает БД
- проверяет раздел БД
- удаляет раздел БД
- создает снова раздел в виде последнего раздела на флешке
- форматирует его
- проверяет
- копирует резервную копию начальной (пустой) БД на этот раздел
- запускает движок БД


Скрипт еще будет полезен при первом запуске на новой флешке, если она больше 16ГБ (или иной носитель). Это расширит емкость раздела БД на весь доступный раздел носителя
Естественно, запустить это можно будет, если сама флешка (раздел с линуксом) не пострадал и загрузка проходит нормально
Скрипт можно вызвать, обратившись по адресу: http://your_IP/setup/db_reset.php
Выполнение займет некоторое время, после чего на экран будет выведен весь лог выполнения

4. Теперь текущая версия вписана в файл /release и выводится в левом верхнем углу главноего меню
5. Обработка IP адреса по настройкам в monitor.ini была поправлена. Ранее, для сохранения произвольно установленного адреса через webmin или вручную, 
файл нужно было удалить. Теперь достаточно в начало строки ip=ххххх поставить #
Этот способ был описан, но не работал верно
6. На системе f2fs файловая система rootfs после загрузки перемонтируется с параметром commit=600
Это позволяет практически исключить обращения на запись к ней. Что, по-идее, должно улучшить надежость запуска ядра linux после сбоев по питанию
7. Переделан образ ext. Потому как на каком-то этапе пропустил сбой в структуре разделов. 
Теперь, как и другой образ, он состоит из 4 разделов: fat32 (MICROART),rootfs,/var,/bases
Все линукс-разделы сделал ext4 с журналированием. Памятуя, что этот образ в основном не для NAND-накопителей. 
rootfs монтируется с commit=600
остальные 2 - коммит по умолчанию
8. Теперь вы можете в любой момент синхронизировать папку исходников с github. И далее скопировать их в рабочие папки.
Для этого, находясь в папке /home/pi/malina достаточно дать команду git pull
Следите за правами копируемых в рабочие папки файлов!
9. В правилах udev для версии f2fs убрано соответствие для /dev/sda Это могло приводить при медленной загрузке к тому, что смонтированный том начинал проверяться fsck,
 и загрузка прерывалась

3.03
Минорное обновление
1. В мастер-узле при отключенной I2C показывались ненулевые значения тока. Поправлено в демоне mapd.
2. Файл /etc/hosts почему-то содержал опять 127.0.1.1 Поправлено 
3. history.php поправлен в разделе "статистика по АКБ". Были ошибочно указаны ампер-часы, а не энергия в Втч

4.01 Большое обновление. Для МАП Доминатор и другие модели с прошивкой 22.3 и выше
 
1. Текст. Убрана дата. Убраны надписи "Не запущен сервис ХХХ". Потому что некрасиво, когда запущен только МАП или контроллер. Вместо этого, когда не запущен ни один сервис, появляется соответствующая надпись.
2. Меню. Главное и Система. Центрированы. Одинаково отображаются на любых экранах
3. Приборы. 
Добавлены:
температура тора (для доминатора)
состояние двух реле (для доминатора)
На вольтметре внешней сети добавлена индикация двух входов для доминатора. Активный – лайм. Нет сети – оранж, есть сеть – светло-голубой
Подсказки теперь появляются рядом с курсором
Переделаны панели БМС, состояния реле контроллера (с анимацией включения/выключения) и номерами
Увеличены живые графики на максимальную ширину раздела. Выровнены по высоте.
На кликабельных элементах курсор в виде указующего перста
Все панели выравнены, немного переработаны цвета
Добавлено всплывающее меню
Индикатор времени отдыха АКБ перенесен на соответствующий живой график
Полоски мощностей теперь изменяют размер плавно, а не скачками
4. История. Добавил просмотр ошибок по МАП и контроллеру.
Для этого заведено 2 новых таблицы в БД map. map_errors и mppt_errors.
Показывается значение ячейки и расшифровка согласно последнему протоколу
5. БМС
Добавлено всплывающее меню. Напряжение средней точки перенесено на середину экрана и оформлено по-человечески
6. Работа с БД
Добавлена кнопка очистки таблиц ошибок МАП и контроллера
7. СМС
добавлена команда #reportmppt
по ней приходит текущий статус MPPT. Напряжения и мощности панелей и АКБ, текущая выработка кВтч, текущий режим
8. Переписаны некоторые участки кода, mysql запросов. А также css стилей. Все не сократил, ибо много, но большущие куски покоцал и переделал. Поскольку ПО росло спонтанно, многие вещи оперативно решались копипастом. Теперь стало возможным многие элементы объединить по стилям.
9. В ИНФО добавлены поля, появившиеся в прошивке 22.3
10. В Мастер-узле добавлена индикация ошибок трехфазной системы
11. Режимы работы МАП расширены. Переписываются прямо внутри демона mapd

    M_OFF  =0 – МАП выключен и нет сети на входе
    M_OFFNET =1 – МАП выключен, но есть сеть на входе (значение напряжения сети выводится в ЖКИ)
    M_ON =2 – МАП включен (происходит генерация 220В от АКБ, нет сети на входе.  
    M_ONNET=3 – МАП включен и транслирует сеть (есть сеть на входе).
    M_ONCHARGE =4 – МАП включен, транслирует сеть и одновременно заряжает АКБ.
    ------------ my extensions------------------------
    10 - принудительная генерация
    11 - тарифная сеть. максимальный тариф. принудительная генерация
    12 - тарифная сеть. минимальный тариф
    13 - трансляция + эко-подкачка
    14 - трансляция + продажа в сеть
    15 - ожидание внешнего заряда
    16 - тарифная сеть. трансляция+эко-подкачка
    17 - тарифная сеть. трансляция+продажа в сеть


12. Добавлен автопоиск портов с устройствами МАМ и MPPT соответствующими сервисами.
При этом исправлена ошибка. Я упустил корректное закрытие порта при неудачном выходе. Теперь дескриптор освобождается и порт закрывается. Соответственно, информация о процессах mapd и mpptd выдает для каждого корректно свой порт.
Информация о поиске и найденном порте видна в логе. 
Иногда, из-за ошибок чтения, сервисам приходится несколько раз рестартовать, и на запуск уходит больше времени. Это нормально.
Поиск происходит в рамках ttyUSB0 и ttyUSB1 (определено в секции #define)
Сервисы стартуют с разбросом во времени в 5с, чтобы избежать одновременного обращения к одному и тому же порту

Из-за подобного новшества, процедура первого пуска RasPi может быть проще 
Достаточно вставить USB провода и запустить ПК. Потом стартовать сервисы. Можно это провести и на работающем ПК.

13. Добавлен в mapd расчет токов по АКБ для батарейного монитора при трехфазной и параллельной системе включения (не протестировано до конца)
14. Добавлено. В mapd и СИСТЕМА-МАП. Ручное управление реле Доминатора. Для этого реле должно находиться в режиме «внешнее управление»
Кнопки контекстно зависимы.
15. Исправлена ошибка проверки диапазона значения емкости АКБ. При некоторых значениях не позволяло записать.  /setup/store.php
16. Для отправки команд МАПу необходимо отметить флажок. Сделано для предотвращения случайной отправки команды.
17. Для Малины. Установлен клиент почты ssmtp. Это не MTA. Всего лишь эмулятор. Работает только по прямому вызову, mail или sendmail. Настройка в файлах / etc/ssmtp
Настройки будут прочитаны при следующем вызове ssmtp 
В качестве образца оставлена настройка для mail.ru 
Не может быть использован как релей.
При ошибке отправки текст письма дописывается в ~/dead.letter
Отправка сбойного письма не повторяется. 
Скрипты.
 /usr/sbin/mail_compose.sh – здесь задается вся логика. Скрипт с комментариями. 
В crontab настроен вызов этого скрипта так же, как и для СМС
Скрипт для теста – /usr/sbin/email.sh mail-to@domain
Отправит тестовое письмо на указанный п/я. Результат в сислоге.

18. Для Малины. Убрана ссылка на apc.so в настройках php. Там же отключены функции mail, sendmail, во избежание неожиданностей
19. В Мастер-узле исправлена индикация батареи с реальным расходом Ач. И-за ошибки в формуле расчета заполнения в node.js батарея не уменьшалась при расходе.
20. В меню ТЕКСТ исправлена индикация напряжения с подстанции со 100В на 0В
(вызвано тем, что МАП хранит напряжение + 100В и 0В соответствует 100)
21. Температуры теперь в БД хранятся как значения со знаком. На панели Приборы для температуры АКБ выделено 3 знакоместа, вместо 2.
22. В БД map-data добавлены поля
_Temp_Grad1, "_Relay1","_Relay2","_Flag_ECO","_RSErrDop","_flagUnet2", соответствующие новым полям протокола
23. Демоны mapd и mpptd теперь открывают еще по одному сегменту памяти и пишут туда текущие данные в формате json 
Этот обмен теперь используют все панели оперативных данных, в т.ч. сетевые (net_map.php и net_mppt.php)
Это исключает обращение к БД и диску
24. В /etc/sudoers добавлено разрешение для stty. Результатом отсутствия было то, что в меню Модем не выводились скорости портов. 
25. В полях дата/время ИСТОРИЯ установлен необходимый формат ввода
26. Изменен порядок обработки полей при поиске данных в ИСТОРИИ.
Теперь дата проверяется на строгое равенство, а время на больше или равно для времени начала,
И меньше или равно для времени окончания.
27. Всплывающее меню добавлено также в BMS, Мультиграф, Мощности
28. В меню настроек МАП добавлены все новые пункты для Доминатора.
29. Для MPPT не отображалось состояние реле. Оказалось, что разработчики втихаря поменяли ячейку. Поправлено. Проверено.
30. Добавлен скрип обслуживания pi_service.sh. Запускается раз в сутки и очищает лог файлы старше 7 дней. Также удаляется файл неотправленных писем dead.letter

4.02
1. Добавлены индикаторы датчиков тока контроллера на панель "Приборы"
2. В раздел "история" добавлены графики на стороне клиента (кнопка D3 JS)
3. Поправлен скрипт /usr/sbin/mail_compose.sh
    Скрипт по умолчанию не исполняется. При настройках в заголовке убрать команду exit 
4. добавлен режим 18 - подкачка Pmax
5. Добавлены поля для построения графиков ДТ1, ДТ2 в "История"
6. Поправилен код mapd в разделе подсчета тока с внешних датчиков контроллера
7. сделана полная локализация МАЛИНЫ. из доступных языков - английский, русский. Выбран сложный путь через функции. Зато теперь малину очень легко на любой язык переделать.
8. расширены опции monitor. ini
Теперь
ip=auto|default|manual
language=ENG|RU
mode=restricted|enabled
protected=system|all - здесь указывается, либо вся Малина запаролена, либо как раньше - только раздел СИСТЕМА
8. добавлен новый пункт меню для Доминатора
9. Скорректированы полоски мощности. Теперь при выходе за номинал не вылазят за подложку
10. Исправлен скрипт обработки monitor.ini Ранее мог не работать, из-за символов CR/LF, котрые остаются при редактировани файла в среде Windows
11. Ссылка для загрузки небольших обновлений теперь http://IP_адрес/update.php вместо update.html
