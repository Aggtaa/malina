Батарейный монитор
Версия системы - 2.06a
Создан для применения с устройствами ООО "МикроАрт" и обеспечивает корректную работу при подключении к блоку батарей:
МАП
МАП+MPPT контроллер
MPPT контроллер
При подключении котроллеров к МАП по шине I2C, количество контроллеров может быть максимально возможным. Данные о всех токах берутся с МАП.
Программно реализован в виде демона batmon 
Для корректной работы демона необходимы последние версии mapd и mpptd 
При запуске демона через веб-интерфейс, в каталоге /var/map создается файл .bmon, который определяет запуск демона batmon. На него же ориентируются php скрипты, определяя, запущен ли сервис. 
Запуск сервисов, как и прежде, контролирует скрипт /usr/bin/map_cd
Демон принудительно может быть завершен командой kill -sigterm `pidof batmon`
Данные по токам, температурам и напряжениям ячеек БМС передаются в batmon через три разделяемые сегмента памяти (ОЗУ) по 1кБ каждый.
Соответственно, все расчетные значения передаются в демон batmon с расчетной точностью типа float стандарта Си, а не в той, что записываются в таблицы mysql.
Разделяемый сегмент памяти создается при старте демона mapd и mpptd соответственно, и не удаляется до перезагрузки ПК
Для просмотра наличия сегментов и ручного удаления сегмента используйте команду linux - ipcs
После запуска, демон остается в памяти и считывает в циклическом режиме данные о токах устройств и напряжении батареи, либо отдельных ячеек, если присутствует БМС. А также, рассчитывает интегральные емкости и энергию (пока не записывается в БД), средний ток за 1 минуту, % емкости по разряду, % емкости по заряду и иные параметры. 
Период интегрирования по умолчанию - 60 секунд. Если вы решите его изменить, учтите, что падение % емкости рассчитывается за период в 1 минуту. И формулу необходимо дополнить.
При отсутствии тока по батарее начинается отсчет времени. По достижению заданного интервала отдыха батареи, выполняется попытка оценить уровень емкости батареи в %% по НРЦ.
При успешной попытке, уровень SOC записывается в таблицу cycle и отображается на панели приборов. Далее, при заряде/разряде производится подсчет отданного/переданного батарее электричества в ампер-часах. Данные по подсчету ампер-часов тоже записываются в таблицу battery_cycle и могут мониторится при необходимости.
При следующей успешной оценке SOC по пропорции производится подсчет общей емкости батареи.
Для системы с БМС SoC определяется по минимальному напряжению ячейки.
Подсчет переданных батарее ампер-часов производится с учетом коэффициента отдачи по емкости.
Примечание: текущая точность измерения напряжения в БМС и МАП не позволяет выполнять точную оценку SOC. Поэтому данные будут весьма приближенными. Для свинцово-кислотных батарей на 12В и выше данные будут более точными. С повышением точности измерения напряжения, методика будет давать более достоверные результаты.
 
БАЗА ДАННЫХ И ТАБЛИЦЫ
Рабочая mysql БД - battery
Пользователь общей БД тот же. По-умолчанию: user:monitor pass:energy
Таблицы:
battery_info 
	все настройки для текущей АКБ
battery_cycle
	поминутно накапливаемые сведения о состоянии батареи. Накапливаются до выполнения принудительного сброса, либо ручной синхронизации на 100%
battery_state
	Статистика по батарее. Данные по циклам, ампер-часам, энергии и пр. Пока не реализовано
estimate 
	В эту таблицу записываются измеренные значения % заряда SOC по напряжению разомкнутой цепи (НРЦ или OCV) 
Lead_acid_OCV
	Таблица соответствия значений НРЦ - % заряда АКБ для свинцово-кислотных ячеек 2В
Lead_acid_OCV_6
	То же, но для батареи на 6 ячеек (обычный 12В аккумулятор)
LiFePo4_37_OCV 
	Таблица значений НРЦ для литий - железофосфатных ячеек 3.7В
work_table
	Текущая рабочая таблица соответствия значений НРЦ - % заряда АКБ
user_OCV 
	Пользовательская таблица соответствия значений НРЦ - % заряда АКБ


НАСТРОЙКА МОНИТОРА И ДАННЫХ АКБ

	Настройка доступна через меню СИСТЕМА-БАТАРЕЯ
Пункты настройки
1. Разделяемый блок АКБ. Зарезервировано для будущих релизов, где к блоку АКБ может быть подключено множество устройств uART
2. Дата ввода в эксплуатацию. Пока не используется. Справочные данные для пользователя
3. Номер батареи. Зарезервировано для будущих релизов с распределенной архитектурой
4. IP адрес центрального сервера. То же.
5. Номинальная емкость батарейного блока. Указывается емкость и время. Если вы не знаете номинальное время разряда для указанной емкости, то как правило это 20ч. На основании этих данных и экспоненты Пейкерта высчитывается номинальная емкость для 20-часового разряда С20 и приведенная емкость для расчета времени работы и процентов разряда, в зависимости от разрядного тока. А также приведенная емкость при данном среднем токе разряда за последнюю минуту
6. Время отдыха. Указывается в минутах. Для свинцово-кислотных и литий-железофосфатных АКБ время отдыха составляет порядка 240минут или 4часа. За это время химические и физические процессы в батарее успевают завершиться, и батарея имеет стабильное напряжение, которое определяет % заряда
7. Температурный коэффициент емкости. Безразмерная величина, определяющая зависимость емкости АКБ от температуры. Учитывается во всех расчетах. Минимальное значение - 0.001
8. Число (экспонента) Пейкерта. Для каждого типа АКБ имеет свое значение. Определяет насколько "сжимается емкость" АКБ при увеличении разрядных токов. Для свинцово-кислотных порядка 1.26. Для литий-железофосфатных рекомендуемая 1.05
9. Коэффициент отдачи по емкости. Каждый тип батарей имеет свой коэффициент. Он определяет отношение отданного количества электричества батарее к тому, которое после можно из нее получить. Для литий - железофосфатных после 30 цикла это число практически равно 99.4-99.6% (0.994-0.996). Для свинцово-кислотных, в начале цикла заряда - 100%, в конце до 80%. Принимается среднее порядка 0.9 (90%)
10. Номинальное напряжение блока. Укажите здесь 12, 24 или 48В. Значение используется в некоторых начальных расчетах параметров системы
11. Напряжение заряда (на блок). Напряжение, выше которого будет выполняться автосинхронизация на 100%, при условии выполнения следующего пункта:
12. Минимальный ток 100% заряда в единицах от указанной номинальной емкости. Например, 0.02С. Это значит, что при С20=250Ач, ток в течение двух минут не должен превысить 5А
13. Количество ячеек (элементов, батарей). Это число определяет то, на какое число будет умножаться напряжение разомкнутой цепи ячейки. Например, если вы выберите 12В таблицу НРЦ, то для 48В вам нужно указать 4 блока, а если вы будете использовать 2В таблицу, то 16 блоков.
14. Тип батареи. Фактически означает какая из таблиц НРЦ будет скопирована в рабочую 
15. Не измерять SOC в диапазоне. Определяет недостоверный диапазон напряжений для измерения % заряда АКБ. Есть смысл применять, если график НРЦ в определенном районе очень пологий и по напряжению тяжело определить % заряда. Также, рекомендуется включить в диапазон высокие степени заряда АКБ, потому как более точный расчет достигается с более глубоких ступеней разряда. Если оба значения равны, то никакой диапазон исключаться не будет
16. Источник данных по току контроллера. Определяет, откуда батарейный монитор будет брать значения токов MPPT. 


Калькулятор числа Пейкерта. 

Если у вашей АКБ в паспорте можно отыскать два значения емкости и два значения номинального времени разряда, то вы можете рассчитать для своей АКБ экспоненту Пейкерта. Например, для 10ч разряда емкость составляет 200Ач. Для 20ч разряда - 220Ач. Экспонента Пейкерта - 1.16

Пункт "редактировать рабочую таблицу"

В этом пункте вы можете видеть все точки соответствия НРЦ - % заряда АКБ
Ноль означает отсутствие данных. Введенную пару можно тут же посмотреть на интерактивном графике, нажав "обновить график".
Для промежуточных данных между опорными точками используется линейная аппроксимация y=kx+b, аналогичная той, которую использует батарейный монитор для расчета промежуточных значений. Наведя указатель мыши на участок графика, можно видеть промежуточное значение пары НРЦ-%заряда.

Таблицу можно сохранить как рабочую, либо пользовательскую


При изменении текущих настроек batmon их перечитывает из БД, о чем появляется соответствующие записи в syslog





Панель "Приборы"

Панель "Приборы" претерпела некоторые изменения
В секции "АКБ" появились новые элементы.

1. Зеленая батарея. Здесь указывается % емкости. При разряде он рассчитывается как % от общего времени работы при данной емкости, температуре и токе разряда. Соответственно, за минуту батарея теряет определенный % емкости. Тем больший, чем больше ток разряда. Зависимость нелинейная и определяется экспонентой Пейкерта. При заряде добавленные ампер-часы, с учетом эффективности батареи, соотносятся с потребленными ампер-часами.
2. Синяя батарея. В левой части указываются реально потребленные ампер-часы от батареи. В правой части при разряде указывается приведенная емкость батареи при данном среднем токе разряда за последнюю минуту и текущей температуре. При покое и заряде - рассчитанная или указанная С20 с учетом текущей температуры батареи. После достижения 100% заряда, ампер-часы в левой части не плюсуются. Такая ситуация нормальна и возникает в случае долгого выравнивания небольшим током, при эко-подкачке. В этом случае в левой части будет 0. Счетчик пользователя будет показывать увеличение отданных батарее ампер-часов. Однако, как правило, это либо небольшое количество для дозаряда, либо избыточный заряд, который не создает дополнительный накопленный заряд в АКБ.
3. Справа от зеленой батареи - таймер отдыха. По таймеру можно определить в течение какого времени ток по АКБ был нулевым.

Ниже графика тока по АКБ находится панель с 4 полями:
1. SOC - после успешного измерения % заряда АКБ по НРЦ, в этом поле указывается текущее значение заряда батареи
2. Time - прогнозное время работы. Высчитывается из соотношения Пейкерта - tIn=const. В покое, при заряде или вычисленном времени более 48ч, показывает >48ч
3. С - последняя измеренная емкость АКБ по уровням НРЦ 
4. COUNTER - счетчик пользователя. Может быть обнулен в любое время. С помощью него можно легко организовать контрольно-тренировочные циклы (КТЦ) батареи постоянным разрядным током.




